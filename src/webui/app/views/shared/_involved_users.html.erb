<% content_for :content_for_head do %>
  <%= javascript_include_tag 'jquery.tablesorter.js' %>
<% end %>

<div id="involved_users">
  <h3><%= @pagetitle %></h3>

  <% if @users and @users.length > 0 %>
    <table cellspacing='1' id="users_table" class="tablesorter">
      <thead>
        <tr>
          <th>User</th>
          <th colspan="<%= @roles.length %>">Roles</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td>
              <%= gravatar_image(@emails[user]) %>
              <% realname = Person.realname_for_login(user) %>
              <% unless realname.empty? %>
                <%= link_to(realname + ' (' + user + ')', :controller => 'home', :user => user) %>
              <% else %>
                <%= link_to(user, :controller => 'home', :user => user) %>
              <% end %>
            </td>
            <% @roles.each do |role| %>
              <td>
                <% if defined? @package %>
                  <%= check_box_tag("role_" + user + "_" + role, '', @package.user_has_role?(user, role) || @project.user_has_role?(user, role)) %><%= role.capitalize %>
                <% else %>
                  <%= check_box_tag("role_" + user + "_" + role, '', @project.user_has_role?(user, role)) %><%= role.capitalize %>
                <% end %>
                <script type="text/javascript">
                  $('#role_<%= user %>_<%= role %>').change(function() {
                    if ($('#role_<%= user %>_<%= role %>').attr('checked')) {
                      <%= remote_function(:update => "", :url => {:action => "save_person", :project => @project, :package => @package, :userid => user, :role => role}) %>
                    } else {
                      <%= remote_function(:update => "", :url => {:action => "remove_person", :project => @project, :package => @package, :userid => user, :role => role}) %>
                    }
                  });
                </script>
              </td>
            <% end %>
            <td>
              <% mail_to = 'mailto:' + Person.email_for_login(user) + '?subject=openSUSE%20Build%20Service%20-%20' + @project.name %>
              <% mail_to += '/' + @package.name if defined? @package %>
              <%= link_to(image_tag('icons/email.png', :alt => "Send mail", :title => "Send mail to user"), mail_to) %>
              <% if @user and @user.is_maintainer?(@project, @package) %>
                <%= link_to image_tag('icons/user_delete.png', :alt => "Remove", :title => "Remove user"), {:action => "remove_person", :project => @project, :package => @package, :userid => user}, {:confirm => "Really remove '#{user}'?", :method => :post}%>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <script type="text/javascript">
      $('#users_table').tablesorter({ widgets: ['zebra'], sortList: [[0,1]], headers: {1: {sorter: false}, 2: {sorter: false}} });
    </script>
  <% end %>
  <% if @user and @user.is_maintainer?(@project, @package) %>
    <p>
      <%= link_to image_tag('icons/user_add.png', :alt => "Add user", :title => "Add user"), :action => :add_person, :package => @package, :project => @project %>
      <%= link_to 'Add user', :action => :add_person, :package => @package, :project => @project %>
    </p>
  <% end %>

  <% if @groups and @groups.length > 0 %>
    <table cellspacing='1' id="groups_table" class="tablesorter">
      <thead>
        <tr>
          <th>Group</th>
          <th colspan="<%= @roles.length %>">Roles</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @groups.each do |group| %>
          <tr>
            <td><%= group %></td/>
            <% @roles.each do |role| %>
              <td>
                <% if defined? @package %>
                  <%= check_box_tag("role_" + group + "_" + role, '', @package.group_has_role?(group, role) || @project.group_has_role?(group, role)) %><%= role.capitalize %>
                <% else %>
                  <%= check_box_tag("role_" + group + "_" + role, '', @project.group_has_role?(group, role)) %><%= role.capitalize %>
                <% end %>
                <% #TODO: Add respective controller actions to support group addition / removal %>
                <script type="text/javascript">
                  $('#role_<%= group %>_<%= role %>').change(function() {
                    if ($('#role_<%= group %>_<%= role %>').attr('checked')) {
                      <%= remote_function(:update => "", :url => {:action => "save_group", :project => @project, :package => @package, :groupid => user, :role => role}) %>
                    } else {
                      <%= remote_function(:update => "", :url => {:action => "remove_group", :project => @project, :package => @package, :groupid => user, :role => role}) %>
                    }
                  });
                </script>
              </td>
            <% end %>
            <td>
              <% if @user and @user.is_maintainer?(@project, @package) %>
                <% #TODO: Add respective controller actions to support group addition / removal %>
                <%= image_tag('icons/group_delete.png', :alt => "Remove", :title => "Remove group") %>

                <%= link_to image_tag('icons/group_delete.png', :alt => "Remove", :title => "Remove group"), {:action => "remove_group", :project => @project, :package => @package, :groupid => user}, {:confirm => "Really remove '#{group}'?", :method => :post}%>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <script type="text/javascript">
      $('#groups_table').tablesorter({ widgets: ['zebra'], sortList: [[0,1]], headers: {1: {sorter: false}, 2: {sorter: false}} });
    </script>
  <% end %>
</div>
