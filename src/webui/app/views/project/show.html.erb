<% @pagetitle = "Show Project #{@project}" %>
<% @crumb_list = [link_to( 'Projects', :action => :list_public), @project.name] -%>

<%= render :partial => "tabs" %>

<div class="grid_9 alpha">
  <div class="show_left box">
    <h3 style="display: inline"><%=h @project.title %><%=  h( @project ) if @project.title.to_s.blank? -%></h3>
    
    <% if (@bugowners_mail and !BUGZILLA_HOST.nil?) or session[:login] %>
      <div id="local-actions">
        <div id="local-actions-items">
          <a href="#" class="dropdown-menu" id="actions-trigger"><strong>Actions</strong></a>
          <ul class="dropdown-menu-content">
            <% if @bugowners_mail and !BUGZILLA_HOST.nil? %>
              <li>
                <%= link_to(image_tag('tools-report-bug.png', :title => 'Report Bug'), bugzilla_url(@bugowners_mail, "#{@project.name}: Bug")) -%>
                <%= link_to('Report Bug', bugzilla_url(@bugowners_mail, "#{@project.name}: Bug")) -%>
              </li>
            <% end -%>
            <% if session[:login] %>
              <% if @project.can_edit?( session[:login] ) %>
                <% if @is_incident_project %>
                  <li>
                    <%= link_to(image_tag('tools-report-bug.png', :title => 'Report Bug'), :action => 'releaserequest', :project => @project) -%>
                    <%= link_to('Release This Maintenance Update', :action => 'releaserequest', :project => @project) -%>
                  </li>
                <% end -%>
                <li>
                  <%= link_to_remote(image_tag('icons/brick_delete.png', :title => 'Delete Project'), :url => {:action => :delete, :project => @project.name}) -%>
                  <%= link_to_remote('Delete Project', :url => { :action => :delete, :project => @project.name}) -%>
                </li>
                <li>
                  <%= link_to(image_tag('icons/brick_edit.png', :title => "Edit Project Information"), :action => 'edit', :project => @project) -%>
                  <%= link_to("Edit Project Information", :action => 'edit', :project => @project) -%>
                </li>
                <% unless @project.is_remote? %>
                  <% if @is_maintenance_project %>
                    <li>
                      <%= link_to(image_tag('icons/brick_add.png', :title => 'Create Incident'), :controller => :project, :action => :create_incident, :ns => @project.name) -%>
                      <%= link_to('Create Incident', :controller => :project, :action => :create_incident, :ns => @project.name) -%>
                    </li>
                  <% else %>
                    <li>
                      <%= link_to(image_tag('icons/brick_add.png', :title => 'Create Subproject'), :controller => :project, :action => :new, :ns => @project.name) -%>
                      <%= link_to('Create Subproject', :controller => :project, :action => :new, :ns => @project.name) -%>
                    </li>
                  <% end %>
                <% end %>
              <% else %>
                <li>
                  <%= link_to_remote(image_tag('icons/package_delete.png', :title => 'Request Deletion'), :url => {:controller => :request, :action => :delete_request_dialog, :project => @project}) %>
                  <%= link_to_remote('Request Deletion', :url => {:controller => :request, :action => :delete_request_dialog, :project => @project}) %>
                </li>
                <li>
                  <%= link_to_remote(image_tag('icons/user_add.png', :title => "Request Role Addition"), :url => {:controller => :request, :action => :add_role_request_dialog, :project => @project}) %>
                  <%= link_to_remote("Request Role Addition", :url => {:controller => :request, :action => :add_role_request_dialog, :project => @project}) %>
                </li>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
    
    <div class="description" id="description">
      <p>
        <% description = @project.description.text %>
        <% if description %>
          <% description.split( /\n/ ).each do |line| %>
            <%=h line -%><br/>
          <% end %>
        <% else -%>
          <i>No description set</i>
        <% end -%>
      </p>
    </div>

    <div>
      <% unless @requests.blank? %>
        <p>
          <%= image_tag 'icons/information.png' %> There <%= plural(@requests.size, "is", "are") %>
          <% if @requests.size == 1 -%>
            1 open <%= link_to "request", :action => :show, :controller => :request, :id => @requests[0].value(:id) %>
          <% else %>
            <%= @requests.size %> open <%= link_to "request#{@requests.size > 1 ? "s" : ""}", :action => :list_requests, :project => @project %>
          <% end %>
        </p>
      <% end %>

      <% if @is_maintenance_project %>
        <p>TODO: This is a maintenance project</p>
      <% else %>
        <% if @nr_of_problem_packages > 0 %>
          <div><p><%= image_tag 'icons/exclamation.png' %> There <%= plural(@nr_of_problem_packages, "is", "are") %> <%= @nr_of_problem_packages %> <%= link_to 'problematic', :action => :monitor, :project => @project, :succeeded => 0, :blocked => 0, :finished => 0, :signing => 0, :dispatching => 0, :scheduled => 0, :building => 0 %>
              <%= plural(@nr_of_problem_packages, "package", "packages") %> of <%= @nr_packages %> <%= link_to 'total', :action => :packages, :project => @project %>.</p></div>
        <% elsif @nr_packages > 0 and not @is_maintenance_project %>
          <p><%= image_tag 'icons/accept.png' %> All <%= @nr_packages %> <%= link_to 'packages', :action => :packages, :project => @project %> are fine.</p>
        <% elsif not @project.is_remote? %>
          <p><%= image_tag 'icons/information.png' %> This project does not have any <%= link_to 'packages', :action => :packages, :project => @project %> yet.</p>
        <% end %>

        <% if @project.is_remote? %>
          <p><%= image_tag 'icons/information.png' %> This project is linking the remote obs instance at: <i>
              <a href="<%= @project.value 'remoteurl' %>"><%= @project.value 'remoteurl' %></a></i></p>
        <% end %>

        <% if @linking_projects.size > 0 %>
          <div><p><%= image_tag 'icons/information.png' %> There <%= plural(@linking_projects.size, "is", "are") %> <%= @linking_projects.size %>
              <%= link_to_remote(plural(@linking_projects.size, "project", "projects"), :url => { :action => :linking_projects, :project => @project } ) %>
              linking this project. </p></div>
        <% end %>
      <% end %>
    </div>
  </div>

</div>

<div class="grid_7 omega"> <!-- no extra margins -->
  <div class="show_right box">
    <% unless @is_maintenance_project %>
      <div class="box-header aligncenter">
        Build Status <%= reload_to_remote(:title => "Reload Status", :url => {:action => "buildresult", :project => @project}, :update => "project_buildstatus") %>
      </div>
      <%= render :partial => 'buildstatus' %>
    <% else %>
      <div class="box-header aligncenter">
        Maintenance Status <%= reload_to_remote(:title => "Reload Status", :url => {:action => "maintenance_status", :project => @project}, :update => "maintenance_status") %>
      </div>
      <%#TODO: render :partial => "maintenance_status" %>
    <% end %>
  </div>
</div>
