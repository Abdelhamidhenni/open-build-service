<% @pagetitle = "Request ##{@id}" %>

<%= javascript_include_tag 'jquery.tablesorter.js' %>

<% content_for :head_javascript do %>

  function insertRow() {
    var type = document.getElementById('add_review_type').value;
    var value = document.getElementById('add_review_name').value;
    var comment = document.getElementById('add_review_comment').value;
    var id = "id_"+type+"_"+value
    var path = "/request/addreviewer/<%=@id%>?comment="+encodeURIComponent(comment)+"&"
    if (type == "User") {
      path = path + "user="+encodeURIComponent(value)
    } else {
      path = path + "group="+encodeURIComponent(value)
    }

    $('#pTable tr:last').before('<tr>'+
      '<td>'+type+'</td>'+
      '<td>'+value+'</td>'+
      '<td>'+comment+'</td>'+
      '<td id="'+id+'">adding...</td>'+
      '</tr>');
    $.ajax({type: "POST", url: path, success: function(data){$("#pTable td#"+id).text(data)} })
  }

  function modifyReview(group, new_state, field_id) {
    var path = "/request/modifyreviewer/<%=@id%>?new_state="+encodeURIComponent(new_state)
    var comment
    if (group != "") {
      path = path + "&group="+encodeURIComponent(group)
      comment = document.getElementById('review_comment_'+group).value;
    } else {
      comment = document.getElementById('review_comment').value;
    }
    path = path + "&comment=" + encodeURIComponent(comment);

    $.ajax({type: "POST", url: path, success: function(data){$("#pTable td#"+field_id).text(data)} })
    $("#pTable td#comment_"+field_id).text(comment)
  }

<% end %>

<%
req = @therequest
@crumb_list = [
  link_to( 'Requests', :controller => :home, :action => :list_requests),
  "Request #{h @id}"
]
-%>

<% if req.state.name == "review" %>
<h2>Review of Request #<%=h @id%></h2>
<% else %>
<h2>Request #<%=h @id%></h2>
<% end %>

<% content_for :content_for_head do %>
  <%= stylesheet_link_tag "SyntaxHighlighter" %>
  <%= javascript_include_tag 'syntax/shCore', 'syntax/shBrushDiff' %>
<% end %>
<% content_for :ready_function do %>
  dp.SyntaxHighlighter.ClipboardSwf = '/flash/clipboard.swf';
  dp.SyntaxHighlighter.HighlightAll('code');
<% end %>

<%-
setup_buildresult_trigger
%>

<div id="build_result_popup"><div id="build_result_html"></div></div>

<table class='request_table'>
  <thead>
    <tr>
      <th>ID</th>
      <th>State</th>
      <th>Requester</th>
      <th>Type</th>
      <th>Source</th>
      <th>Target</th>
    </tr>
  </thead>
  <tbody>
      <%  if req.has_element? :action
          actions = req.each_action
          length = actions.length
      else
          actions = [req.submit]
          length = 1
      end
      first = true %>
      <% req.each_action do |action| %>
        <tr>
          <% if first %>
             <td rowspan="<%= length %>"><%= req.value :id %></td>
             <td rowspan="<%= length %>"><%= req.state.name %></td>
             <td rowspan="<%= length %>"><%= link_to req.state.who, :controller => :project, :action => "show", :project => "home:"+req.state.who %></td>
             <% first = nil %>
          <% end %>
          <td>
            <% if req.has_element? :action %>
              <%= action.data.attributes["type"] %>
            <% else %>
              submit
            <% end -%>
          </td>
          <td>
            <%= if action.has_element? :source
              package_link(action.source.project, action.source.value(:package))
            end -%>
          </td>
          <td>
            <%= if action.has_element? :target
              package = action.target.value(:package)
              package_link(action.target.project, package) if package
            end -%>
          </td>
        </tr>
      <% end -%>
    <tr>
      <td colspan="6"><code><%= h(req.value('description') || "-") %></code></td>
    </tr>
  </tbody>
</table>

<% if @newpackage.length > 0 %>
  <h3>
    New package will be added:
    <% @newpackage.each do |p| %>
      <%=  link_to( p[:package], :controller => :package, :action => :show, :project => p[:project], :package => p[:package]) %>
    <% end %>
  </h3>
<% end %>

<% if @diff_text %>
  <pre id="code" class="patch">
    <%= h @diff_text %>
  </pre>
<% end %>

<% if !["accepted", "declined", "revoked"].include? @state and (@is_reviewer || @is_maintainer || @is_author) and (@is_author || !@diff_error) %>
  <p/>
  <div class="section">
    <% form_tag :action => "changerequest" do %>
      <div>
        <% if !@diff_error and (@is_maintainer or @is_reviewer or @is_author or req.each_review.length > 0) %>
          <!-- handle existing reviews -->
          <table id="pTable">
          <tr><th colspan="4">Reviews</th></tr>
          <tr><th></th><th valign="top">Owner</th><th>Comment</th><th>State</th></tr>
          <% req.each_review do |r|%>
            <%- comment=nil
                comment=r.comment if r.has_element? :comment %>
            <tr>
            <% if r.has_attribute? :by_user %>
              <td>User</td> <td><%=r.by_user%></td>
              <% if @is_reviewer and req.state.name == "review" and r.state.to_s == "new" and r.by_user.to_s == @user.login.to_s %>
                <td id="comment_user_<%=r.by_user%>"><%=text_area_tag "review_comment", comment, :size => "50x2" %></td>
                <td id="user_<%=r.by_user%>">
                  <%= button_to_function "Approve", :onclick => "modifyReview(\"\", \"accepted\", \"user_#{r.by_user}\")" %>
                  <%= button_to_function "Reject", :onclick => "modifyReview(\"\", \"declined\", \"user_#{r.by_user}\")" %>
              </td>
              <% else %>
                <td><%= comment%></td>
                <td><%= r.state %></td>
              <% end %>
            <%end%>

            <% if r.has_attribute? :by_group %>
              <td>Group</td> <td><%=r.by_group%></td>
              <% if @is_reviewer and req.state.name == "review" and r.state.to_s == "new" and @user.is_in_group? r.by_group %>
                <td id="comment_group_<%=r.by_group%>"><%=text_area_tag "review_comment_#{r.by_group}", comment, :size => "50x2" %></td>
                <td id="group_<%=r.by_group%>">
                  <%= button_to_function "Approve", :onclick => "modifyReview(\"#{r.by_group}\", \"accepted\", \"group_#{r.by_group}\")" %>
                  <%= button_to_function "Reject", :onclick => "modifyReview(\"#{r.by_group}\", \"declined\", \"group_#{r.by_group}\")" %>
                </td>
              <% else %>
                <td><%= comment%></td>
                <td><%= r.state %></td>
              <% end %>
            <%end%>
            </tr>
          <%end%>

          <!-- add another review -->
          <% if !@diff_error and (req.state.name == "review" or req.state.name == "new") %>
            <% if @is_maintainer or @is_reviewer or @is_author %>
              <tr class="add_reviewer">
                <td><%=select_tag "add_review_type", "<option>User</option> <option>Group</option>" %></td>
                <td><%=text_field_tag "add_review_name" %></td>
                <td><%=text_area_tag "add_review_comment", nil, :size => "50x2" %></td>
                <td><%=button_to_function "Add Reviewer" do |r|
                         r.call :insertRow
                       end %></td>
              </tr>
            <% end %>
          <% end %>
          </table>
        <% end %>

        <!-- handle the request itself -->
        <%= hidden_field_tag( "id", @id) %>
        <% if @is_maintainer %>
          <p>
            <strong>Reason:</strong>
            <%= text_field_tag :reason, '' , :size => 80 %><br/>
          </p>
          <% linked = @target_pkg.linked_to if @target_pkg -%>
          <% if !@diff_error -%>
            <% if linked and not linked.empty? and @therequest.action.data["type"] == "submit" -%>
              <%= hidden_field_tag( "forward_project", linked[0]) %>
              <%= hidden_field_tag( "forward_package", linked[1]) %>
              <%= submit_tag "Forward to %s" % linked, :name => 'forward' %>
            <% end -%>
            <% if req.state.name.to_s == "review" %>
              <%= submit_tag "Accept", :name => 'accepted', :confirm => "Do you really wan't to approve this request, despite of open review requests ?" %>
            <% else %>
              <%= submit_tag "Accept", :name => 'accepted' %>
            <% end %>
          <% end %>
          <%= submit_tag "Decline", :name => 'declined' %>
        <% elsif @is_author %>
          <p>
            <strong>Reason:</strong>
            <%= text_field_tag :reason, '' , :size => 80 %><br/>
          </p>
          <%= submit_tag "Revoke", :name => 'revoked' %>
        <% end %>
      </div>
    <% end %>
  </div>

<% end %>

