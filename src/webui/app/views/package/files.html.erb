
<% @pagetitle = "Files of Package #{@package} (Project #{@project})" %>
<% package_bread_crumb 'Files' -%>

<%= render :partial => "tabs" %>

<%= javascript_include_tag 'jquery.tablesorter.js' %>

<% content_for :head_javascript do %>


  function insertRow() {
    var name     = document.getElementById('add_new_parameter').value;
    var service  = document.getElementById('servicename').value;
    var value    = document.getElementById('add_new_value').value;
    var number   = document.getElementById('count_parameters').value + 1;

    $('#pTable tr:last').before('<tr class=\"row_'+number+'\">'+
      '<td>'+name+'</td>'+
      '<td id="added_parameter_'+number+'">...</td>'+
      '<td><a href=\"#\" onclick=\"\$(\'tr.row_'+number+'\').remove(); return false;\">X</a></td>'+
      '</tr>');
    
    document.getElementById('count_parameters').value = number;

    var path="/package/service_parameter_value?number="+number+"&servicename="+escape(service)+"&parameter="+escape(name)+"&value="+escape(value)+"&package=<%=@package%>&project=<%=@project%>";
    $("#pTable td#added_parameter_"+number).load(path);
  }

  function slide_history_up() {
    var number = parseInt(document.getElementById('history_browser_revision').value);
    number = number + 1;
    document.getElementById('history_browser_revision').value = number;
    $('#go_down_button').show();
    if (number == <%=@maxrevision%>) {
      $('#go_up_button').hide();
    }

    $('#historyTable tr:last').remove();
    $('#historyTable tr:first').before('<tr>'+
      '<td id=\"commit_item_'+number+'\">...</td>'+
      '</tr>');

    var path = "/package/commit?revision="+number+"&package=<%=@package%>&project=<%=@project%>";
    $("#historyTable td#commit_item_"+number).load(path);
  }

  function slide_history_down() {
    var number = parseInt(document.getElementById('history_browser_revision').value);
    number = number - 1;
    document.getElementById('history_browser_revision').value = number;

    number = number - parseInt(<%=@visible_commits%>) + 1;
    $('#go_up_button').show();
    if (number == 1) {
      $('#go_down_button').hide();
    }
    $('#historyTable tr:first').remove();
    $('#historyTable tr:last').after('<tr>'+
      '<td id=\"commit_item_'+number+'\">...</td>'+
      '</tr>');

    var path = "/package/commit?revision="+number+"&package=<%=@package%>&project=<%=@project%>";
    $("#historyTable td#commit_item_"+number).load(path);
  }

<% end %>


<% content_for :ready_function do %>
  $("#files_table").tablesorter( {
  sortList: [[0,1]],
  widgets: ['zebra'],
  headers: {
  3: { sorter: false }
  }
  } );
<% end %>


<%= render :partial => 'links' if @link %>

<%= render :partial => 'services' if @services %>

<!-- Source history -->
<div class="grid_7 alpha">
<div class="show_left box">
 <div class="box-header aligncenter">
   Commit History <%= image_tag('ajax-loader.gif', :id => 'spinner_history', :class => 'hidden') %>
 </div>
 <div id="package_history">
    <h3>
    </h3>

    <%= render :partial => 'sources_history', :locals => {:currentRevision => @revision, :history => @history} %>

    <%= observe_field( :mergesettings, :frequency => 0.5, :update => :sources_history,
      :url => { :controller => 'package', :action  => 'sources_history', :project => @project, :package => @package, :revision => @revision },
      :loading => "$('#spinner_files').show();", :complete => "$('#spinner_files').hide();",
      :with => "'rev=' + escape($('#revision').attr('value')) + '&expand=' + $('#mergesettings')[0].checked") %>
  </div>
</div>
</div>

<!-- File list -->
<div class="grid_9 omega">
 <div class="show_right box">
  <div class="box-header aligncenter">
    Source Files <%= image_tag('ajax-loader.gif', :id => 'spinner_files', :class => 'hidden') %>
  </div>

  <div id="package_files">
    <% unless @files.empty? %>
      <%= render :partial => 'files_view', :locals => {:file_list => @files} %>

      <% if @expand %>
        <%= check_box_tag 'mergesettings', 'merge', true -%>
      <% elsif @link %>
        <%= check_box_tag 'mergesettings', 'merge', false -%>
      <% end %>
      <% if @link %>
        Show merged sources derived from linked package.
      <% end %>

      <%= observe_field( :mergesettings, :frequency => 0.5, :update => :files_view,
        :url => { :controller => 'package', :action  => 'file_table', :project => @project, :package => @package },
        :loading => "$('#spinner_files').show();", :complete => "$('#spinner_files').hide();",
        :with => "'rev=' + escape($('#revision').attr('value')) + '&expand=' + $('#mergesettings')[0].checked") %>

      <%= observe_field( :revision, :frequency => 1, :update => :files_view,
        :url => { :controller => 'package', :action  => 'file_table', :project => @project, :package => @package },
        :loading => "$('#spinner_files').show();", :complete => "$('#spinner_files').hide();",
        :with => "'rev=' + escape($('#revision').attr('value')) + '&expand=' + $('#mergesettings')[0].checked") %>
      <%= observe_field( :srcmd5, :frequency => 1, :update => :files_view,
        :url => { :controller => 'package', :action  => 'file_table', :project => @project, :package => @package },
        :loading => "$('#spinner_files').show();", :complete => "$('#spinner_files').hide();",
        :with => "'srcmd5=' + escape($('#srcmd5').attr('value')) + '&expand=' + $('#mergesettings')[0].checked") %>
    <% end %>
  
    <% if @package.can_edit?( session[:login] ) %>
      <p><%= link_to image_tag('icons/page_white_add.png', :alt => "Add", :title => "Add File"),
  	:action => :add_file, :project => @project, :package => @package %>
        <%= link_to 'Add File', :action => :add_file, :project => @project, :package => @package %>
      </p>
    <% end %>
  
  </div>
 </div>
</div>

