<% index ||= '' %>
<p>
  <%= select_tag("rpmlint_repo_select_#{index}", options_for_select(@repo_arch_hash.keys)) %>
  <% i = 0 %>
  <% @repo_arch_hash.each do |repo, arches| %>
    <%= select_tag("rpmlint_arch_select_#{index}_#{repo}", options_for_select(arches), :class => "rpmlint_arch_select_#{index}") %>
  <% end %>
  <%= image_tag('ajax-loader.gif', :id => "rpmlint_spinner_#{index}", :class => 'hidden') %>
</p>

<p id="rpmlint_display_<%= index %>">
</p>

<% javascript_tag do %>
  $('.rpmlint_repo_select_<%= index %>').change(function (data) {
    $('.rpmlint_arch_select_<%= index %>').hide();
    $('#rpmlint_arch_select_<%= index %>_' + $('#incident_type_select').attr('value')).show();
    update_rpmlint_display();
  });

  function update_rpmlint_display() {
    $('#rpmlint_spinner_<%= index %>').show();
    repo = $('#rpmlint_repo_select_<%= index %>').attr('value')
    $.ajax({
      url: '<%= url_for(:controller => 'package', :action => 'rpmlint_log') %>',
      data: {
        'project': '<%= @project.value('name') %>',
        'package': '<%= @package.value('name') %>',
        'repository': repo,
        'architecture': $('#rpmlint_arch_select_<%= index %>_' + repo).attr('value'),
      },
      success: function (data) {
        $('#rpmlint_display_<%= index %>').html(data);
      },
      complete: function (data) {
        $('#rpmlint_spinner_<%= index %>').hide();
      },
    });
  }

  $('.rpmlint_arch_select_<%= index %>').change(update_rpmlint_display);
  update_rpmlint_display();
<% end %>
