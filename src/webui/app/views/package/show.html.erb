<% @pagetitle = "Show Package #{@package} (Project #{@project})" %>
<% project_bread_crumb @package.name -%>

<%= render :partial => "tabs" %>

<div class="grid_9 alpha">
  <div class="box show_left">
    <h3 style="display: inline"><%=h @package %></h3>

    <p><%=h @package.title %></p>
    <%= render :partial => "shared/description", :locals => {:description => @package.description.text} %>

    <div class="grid_4 alpha">
      <h4>Information</h4>
      <ul class="clean_list">
        <li>
          <% nr_files = @package.files.size %>
          <% if nr_files == 0 %>
            <%= image_tag 'icons/exclamation.png' %>
          <% else %>
            <%= image_tag 'icons/accept.png' %>
          <% end %>
          <%= nr_files %> <%= link_to "file#{nr_files == 1 ? "" : "s"}", :action => :files, :project => @project, :package => @package %>
        </li>
        <% if @failures and @failures > 0 %>
          <li>
            <%= image_tag 'icons/exclamation.png' %> 
            <%= @failures %>
            <%= link_to "error#{@failures == 1 ? "" : "s"}", :action => :monitor, :project => @project, :succeeded => 0, :blocked => 0, :finished => 0, :signing => 0, :dispatching => 0, :scheduled => 0, :building => 0, :controller => :project, :pkgname => @package.name %>
          </li>
        <% end %>

        <li><%= render :partial => "shared/open_requests" %></li>

        <% if @package.has_element? :devel %>
          <li>
            <% dpackage = @package.devel.data["package"] || @package.name %>
            <%= image_tag 'icons/information.png' %>
            Maintained in <%= link_to(elide(@package.devel.project, 44), :action => :show, :controller => :package, :project => @package.devel.project, :package => dpackage) %>
          </li>
        <% end %>

        <% if @package.name =~ %r{^_patchinfo} %>
          <p>
            <%= image_tag 'icons/information.png' %>
            Has a <%= link_to 'patchinfo', :controller => :patchinfo, :action => :show, :package => @package, :project => @project %>
            for <%= link_to 'maintenance updates', 'http://wiki.opensuse.org/openSUSE:Maintenance' %>
            <%#TODO: Fix this hard link %>
          </p>
        <% end %>

        <% if @linking_packages and @linking_packages.size > 0 %>
          <li>
            <%= image_tag 'icons/information.png' %>
            <%= @linking_packages.size %> <%= link_to_remote "derived packages", :url => { :action => :linking_packages, :project => @project, :package => @package } %>
          </li>
        <% end %>
      </ul>
    </div>

    <div class="grid_4 omega">
      <% if (@bugowners_mail and !BUGZILLA_HOST.nil?) or session[:login] %>
        <h4>Actions</h4>
        <ul class="clean_list">
          <% if @bugowners_mail and !BUGZILLA_HOST.nil? %>
            <li>
              <%= link_to image_tag('tools-report-bug.png', :title => 'Report Bug'), bugzilla_url(@bugowners_mail, "#{@project.name}/#{@package.name}: Bug") %>
              <%= link_to 'Report Bug', bugzilla_url(@bugowners_mail, "#{@project.name}/#{@package.name}: Bug") %>
            </li>
          <% end %>
          <% if session[:login] %>
            <% if Package.current_rev(@project, @package) %>
              <li>
                <%= link_to_remote image_tag('icons/arrow_branch.png', :title => 'Branch Package'), :url => {:action => :branch_dialog, :project => @project, :package => @package} %>
                <%= link_to_remote 'Branch Package', :url => { :action => :branch_dialog, :project => @project, :package => @package} %>
              </li>
              <li>
                <%= link_to_remote image_tag('icons/package_go.png', :title => 'Submit Package'), :url => { :action => :submit_request_dialog, :project => @project, :package => @package} %>
                <%= link_to_remote 'Submit Package', :url => { :action => :submit_request_dialog, :project => @project, :package => @package} %>
              </li>
            <% end %>
            <% if @package.can_edit?(session[:login]) %>
              <li>
                <%= link_to image_tag('icons/package_edit.png', :title => "Edit Description"), :action => 'edit', :project => @project, :package => @package, :spec_count => @spec_count -%>
                <%= link_to "Edit Description", :action => 'edit', :project => @project, :package => @package, :spec_count => @spec_count -%>
              </li>
              <li>
                <%= link_to_remote image_tag('icons/package_delete.png', :title => 'Delete Package'), :url => { :action => :delete_dialog, :package => @package, :project => @project } -%>
                <%= link_to_remote 'Delete Package', :url => { :action => :delete_dialog, :package => @package, :project => @project } -%>
              </li>
            <% else %>
              <li>
                <%= link_to_remote(image_tag('icons/user_add.png', :title => "Request Role Addition"), :url => {:controller => :request, :action => :add_role_request_dialog, :project => @project, :package => @package}) %>
                <%= link_to_remote("Request Role Addition", :url => {:controller => :request, :action => :add_role_request_dialog, :project => @project, :package => @package}) %>
              </li>
              <li>
                <%= link_to_remote image_tag('icons/package_delete.png', :title => 'Request Deletion'), :url => {:controller => :request, :action => :delete_request_dialog, :project => @project, :package => @package} %>
                <%= link_to_remote 'Request Deletion', :url => {:controller => :request, :action => :delete_request_dialog, :project => @project, :package => @package} %>
              </li>
            <% end %>
          <% end %>
        </ul>
      <% end %>
    </div>
    <div class="clear"></div>
  </div>
</div>

<div class="grid_7 omega">
  <div class="box show_right">
    <div class="box-header aligncenter">
      Build Status <%= reload_to_remote(:title => "Reload Status", :url => {:action => "reload_buildstatus", :project => @project, :package => @package}, :update => "package_buildstatus") %>
    </div>
    <%= render :partial => 'buildstatus' %>
  </div>
</div>
